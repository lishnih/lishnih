' Export_Doc_to_Xml (December 02, 2010)
' ©2010 Stan http://lishnih.net
' lishnih@gmail.com
' Rev.2 15.12.2010

Sub CreateFolder(dirname)
    Set fs = CreateObject("Scripting.FileSystemObject")
    
    If Not fs.FolderExists(dirname) Then
        fs.CreateFolder (dirname)
    End If
End Sub

Sub Write_tag(file_desc, tag_name, tag_value, Optional level = 1)
    sp = Space(level * 2)
    file_desc.WriteLine (sp & "<" & tag_name & ">" & tag_value & "</" & tag_name & ">")
End Sub

Function Trim_white_spaces(text)
    text = Replace(text, Chr(13), "")
    text = Replace(text, Chr(10), "")
    text = Replace(text, Chr(7), "")
    Trim_white_spaces = Trim(text)
End Function

Function Get_text_after_find(search_text)
    Selection.Find.ClearFormatting
    With Selection.Find
        .text = search_text
        .Replacement.text = ""
        .Forward = True
        .Wrap = wdFindContinue
        .Format = False
        .MatchCase = False
        .MatchWholeWord = False
        .MatchWildcards = False
        .MatchSoundsLike = False
        .MatchAllWordForms = False
    End With
    Selection.Find.Execute
    If Selection.Find.Found Then
        Selection.MoveRight Unit:=wdCharacter, Count:=1
        Selection.EndKey Unit:=wdLine, Extend:=wdExtend
        Get_text_after_find = Trim_white_spaces(Selection.text)
    Else
        Response = MsgBox(search_text, Title:=ActiveDocument.FullName)
        Get_text_after_find = ""
    End If
End Function

Sub Recognize_and_Save_Xml(xmlFileName)
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set a = fs.CreateTextFile(xmlFileName, True, True)
    a.WriteLine ("<root>")

'   Данные распознавания
    Write_tag a, "source", ActiveDocument.FullName
    Write_tag a, "date", Date
    Write_tag a, "time", Time
    a.WriteLine ("")

'   Данные заключения
    a.WriteLine ("  <report>")

    object_text = Get_text_after_find("Наименование объекта")
    quality_text = Get_text_after_find("Уровень качества")
    pipeline_text = Get_text_after_find("Название трассы")
    spread_text = Get_text_after_find("Участок трубопровода, километраж")
    contractor_text = Get_text_after_find("Наименование организации Подрядчика")
    customer_text = Get_text_after_find("Наименование организации Заказчика")
    report_text = Get_text_after_find("З А К Л Ю Ч Е Н И Е №")
    date_text = Get_text_after_find("От")

    Write_tag a, "object", object_text
    Write_tag a, "quality", quality_text
    Write_tag a, "pipeline", pipeline_text
    Write_tag a, "spread", spread_text
    Write_tag a, "contractor", contractor_text
    Write_tag a, "customer", customer_text
    Write_tag a, "report", report_text
    Write_tag a, "date", date_text

    a.WriteLine ("  </report>")

'   Данные стыка
    a.WriteLine ("  <report>")

    t = ActiveDocument.Tables.Count
    If t >= 4 Then
        Selection.GoTo What:=wdGoToTable, Which:=wdGoToFirst, Count:=4, Name:=""
        Selection.SelectCell
        Selection.MoveDown Unit:=wdLine, Count:=2
        Selection.MoveRight Unit:=wdCell, Count:=1
        Selection.SelectCell
        joint_text = Trim_white_spaces(Selection.text)
        Selection.MoveRight Unit:=wdCharacter, Count:=1
        Selection.SelectCell
        dt_text = Trim_white_spaces(Selection.text)
        Selection.MoveRight Unit:=wdCharacter, Count:=1
        Selection.SelectCell
        welders_text = Trim_white_spaces(Selection.text)
        Selection.MoveRight Unit:=wdCell, Count:=4
        Selection.SelectCell
        decision_text = Trim_white_spaces(Selection.text)

        Write_tag a, "joint", joint_text
        Write_tag a, "dt", dt_text
        Write_tag a, "welders", welders_text
        Write_tag a, "decision", decision_text
    End If

    a.WriteLine ("</root>")
    a.Close
End Sub

Sub Export_Doc_to_Xml(sFullName, xmlFileName)
'   MsgBox (sFileName)
    Documents.Open FileName:=sFullName, _
        ConfirmConversions:=False, ReadOnly:=True, AddToRecentFiles:=False, _
        PasswordDocument:="", PasswordTemplate:="", Revert:=False, _
        WritePasswordDocument:="", WritePasswordTemplate:="", Format:=wdOpenFormatAuto

    Recognize_and_Save_Xml xmlFileName

    ActiveDocument.Close
End Sub

Sub Walk_Dir(sDocsPath, sXmlsPath, fs, a)
    If Right(sDocsPath, 1) <> "\" Then
        sDocsPath = sDocsPath & "\"
    End If

    CreateFolder (sXmlsPath)

    Set F = fs.GetFolder(sDocsPath)
    Set fc = F.SubFolders
    For Each fDir In fc
        Walk_Dir fDir, sXmlsPath & "\" & fDir.Name, fs, a
    Next

    lstAttr = vbNormal + vbReadOnly + vbHidden + vbSystem ' + vbDirectory
    sFileName = Dir(sDocsPath, lstAttr)

    Do While sFileName <> ""
        If sFileName <> "." And sFileName <> ".." Then
            ext = Right(sFileName, 4)
            If ext = ".doc" Then
                a.WriteLine (sDocsPath & sFileName)
                xmlFileName = sXmlsPath & "\" & Replace(sFileName, ".doc", ".xml")
                Export_Doc_to_Xml sDocsPath & sFileName, xmlFileName
            End If
        End If

        sFileName = Dir
    Loop
End Sub

Sub Export_Docs_Dir_to_Xml()

    sDocsPath = "D:\home\bu41\Заключения_doc\РК трасса"
    sXmlsPath = "D:\xml_reports"

'   On Error Resume Next
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set a = fs.CreateTextFile("c:\flist.txt", True, True)

    Walk_Dir sDocsPath, sXmlsPath, fs, a

    a.Close
End Sub

Sub Export_Opened_Doc_to_Xml()

    sXmlsPath = "D:\xml_report1"

'   On Error Resume Next
    CreateFolder (sXmlsPath)

    sFileName = ActiveDocument.Name
    xmlFileName = sXmlsPath & "\" & Replace(sFileName, ".doc", ".xml")
    Recognize_and_Save_Xml xmlFileName
End Sub

