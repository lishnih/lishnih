' Export_Doc_to_Xml
' stan December 02, 2010

Sub Write_tag(file_desc, tag_name, tag_value)
    file_desc.WriteLine ("  <" & tag_name & ">" & tag_value & "</" & tag_name & ">")
End Sub

Function Trim_white_spaces(text)
    text = Replace(text, Chr(13), "")
    text = Replace(text, Chr(10), "")
    text = Replace(text, Chr(7), "")
    Trim_white_spaces = Trim(text)
End Function

Function Get_text_after_find(search_text)
    Selection.Find.ClearFormatting
    With Selection.Find
        .text = search_text
        .Replacement.text = ""
        .Forward = True
        .Wrap = wdFindContinue
        .Format = False
        .MatchCase = False
        .MatchWholeWord = False
        .MatchWildcards = False
        .MatchSoundsLike = False
        .MatchAllWordForms = False
    End With
    Selection.Find.Execute
    If Selection.Find.Found Then
        Selection.MoveRight Unit:=wdCharacter, Count:=1
        Selection.EndKey Unit:=wdLine, Extend:=wdExtend
        Get_text_after_find = Trim_white_spaces(Selection.text)
    Else
        MsgBox (search_text)
        Get_text_after_find = ""
    End If
End Function

Sub Export_Doc_to_Xml(FileName_out)
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set a = fs.CreateTextFile(FileName_out, True, True)
    a.WriteLine ("<root>")
    
    object_text = Get_text_after_find("Наименование объекта")
    quality_text = Get_text_after_find("Уровень качества")
    pipeline_text = Get_text_after_find("Название трассы")
    spread_text = Get_text_after_find("Участок трубопровода, километраж")
    contractor_text = Get_text_after_find("Наименование организации Подрядчика")
    customer_text = Get_text_after_find("Наименование организации Заказчика")
    report_text = Get_text_after_find("З А К Л Ю Ч Е Н И Е №")
    date_text = Get_text_after_find("От")

    Write_tag a, "object", object_text
    Write_tag a, "quality", quality_text
    Write_tag a, "pipeline", pipeline_text
    Write_tag a, "spread", spread_text
    Write_tag a, "contractor", contractor_text
    Write_tag a, "customer", customer_text
    Write_tag a, "report", report_text
    Write_tag a, "date", date_text

    Selection.GoTo What:=wdGoToTable, Which:=wdGoToFirst, Count:=4, Name:=""
    Selection.SelectCell
    Selection.MoveDown Unit:=wdLine, Count:=2
    Selection.MoveRight Unit:=wdCell, Count:=1
    Selection.SelectCell
    joint_text = Trim_white_spaces(Selection.text)
    MsgBox (joint_text)
    Selection.MoveRight Unit:=wdCharacter, Count:=1
    Selection.SelectCell
    dt_text = Trim_white_spaces(Selection.text)
    MsgBox (dt_text)
    Selection.MoveRight Unit:=wdCharacter, Count:=1
    Selection.SelectCell
    welders_text = Trim_white_spaces(Selection.text)
    MsgBox (welders_text)
    Selection.MoveRight Unit:=wdCell, Count:=4
    Selection.SelectCell
    decision_text = Trim_white_spaces(Selection.text)
    MsgBox (decision_text)

    Write_tag a, "joint", joint_text
    Write_tag a, "dt", dt_text
    Write_tag a, "welders", welders_text
    Write_tag a, "decision", decision_text
    
    a.WriteLine ("</root>")
    a.Close
End Sub

Sub Export_DocsDir_to_Xml()
    DocsDir = "D:\__dev__"
    
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set f = fs.GetFolder(DocsDir)
    Set fc = f.Files
    For Each FileName_in In fc
        FullName = CStr(FileName_in)
        ext = Right(FileName_in.Name, 4)
        If ext = ".doc" Then
            Documents.Open FileName:=FullName, _
                ConfirmConversions:=False, ReadOnly:=True, AddToRecentFiles:=False, _
                PasswordDocument:="", PasswordTemplate:="", Revert:=False, _
                WritePasswordDocument:="", WritePasswordTemplate:="", Format:= _
                wdOpenFormatAuto, XMLTransform:=""

            FileName_out = Replace(FileName_in, "СУ-4", "СУ-4_export")
            FileName_out = Replace(FileName_out, ".doc", ".xml")
            Export_Doc_to_Xml FileName_out

            ActiveDocument.Close
        End If
    Next
End Sub

